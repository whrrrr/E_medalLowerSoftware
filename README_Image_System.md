# 图像传输系统说明文档

## 系统概述

本系统实现了一个完整的图像传输和显示解决方案，支持通过蓝牙模块接收400×300像素的黑白+红白双色图像数据，并将其存储到Flash中，最后显示到EPD屏幕上。

## 系统架构

### 核心模块

1. **图像接收器 (image_receiver.c/h)**
   - 协议解析和数据包处理
   - 数据完整性校验 (CRC16)
   - 自动重传机制
   - 边接收边存储到Flash

2. **图像显示器 (image_display.c/h)**
   - 从Flash读取图像数据
   - RLE解压缩支持
   - EPD显示接口

3. **Flash管理器 (flash_manager.c/h)**
   - 数据存储和读取
   - 垃圾回收机制
   - 磨损均衡

### 传输协议

#### 帧格式
```
+--------+-----+-----+-----+----------+-----+
| Header | CMD | SEQ | LEN |   DATA   | CRC |
+--------+-----+-----+-----+----------+-----+
|   4B   | 1B  | 2B  | 1B  |  240B    | 2B  |
+--------+-----+-----+-----+----------+-----+
```

- **Header**: 0xAA55A55A (固定帧头)
- **CMD**: 命令类型
  - 0x01: START (开始传输)
  - 0x02: DATA (数据包)
  - 0x03: END (结束传输)
  - 0x04: ACK (确认)
  - 0x05: NACK (否认)
- **SEQ**: 序列号 (0-65535)
- **LEN**: 数据长度 (0-240)
- **DATA**: 数据载荷
- **CRC**: CRC16校验码

#### 传输流程

1. **开始阶段**
   ```
   上位机 -> 下位机: START帧 (包含图像ID和总包数)
   下位机 -> 上位机: ACK
   ```

2. **数据传输阶段**
   ```
   上位机 -> 下位机: DATA帧 (序列号递增)
   下位机 -> 上位机: ACK/NACK
   (如果NACK，上位机重传，最多3次)
   ```

3. **结束阶段**
   ```
   上位机 -> 下位机: END帧
   下位机 -> 上位机: ACK
   ```

### 内存管理策略

#### 缓冲区复用
- **g_flash_buffer (256字节)**: Flash读写缓冲区
- **g_image_buffer (256字节)**: 图像数据累积缓冲区
- **g_protocol_buffer**: 协议解析缓冲区

#### 存储策略
- 每接收256字节数据写入一次Flash
- 数据ID格式: `图像ID * 1000 + 块序号`
- 支持最大30KB图像 (400×300×2/8)

### 数据压缩

#### RLE压缩算法
- 适用于黑白图像的简单压缩
- 压缩格式:
  - 重复数据: `0x80 | 重复次数` + `数据值`
  - 非重复数据: 直接存储

## 使用方法

### 下位机端

1. **编译和烧录**
   ```bash
   # 确保所有源文件都包含在项目中
   # 编译项目并烧录到MCU
   ```

2. **运行**
   - 系统启动后自动初始化所有模块
   - 通过串口输出调试信息
   - 自动处理图像接收和显示

### 上位机端

1. **安装依赖**
   ```bash
   pip install pyserial
   ```

2. **运行测试程序**
   ```bash
   python test_sender.py
   ```

3. **配置串口**
   - 修改 `test_sender.py` 中的 `PORT` 变量
   - Windows: `"COM3"`
   - Linux: `"/dev/ttyUSB0"`

## 性能参数

### 传输性能
- **图像大小**: 30,000字节 (400×300×2/8)
- **最大包大小**: 240字节
- **总包数**: 约125包
- **传输时间**: 约10-15秒 (115200波特率)

### 内存使用
- **RAM**: 约1KB (主要是缓冲区)
- **Flash**: 根据图像数量动态分配

### 可靠性
- **CRC16校验**: 确保数据完整性
- **自动重传**: 最多3次重试
- **超时处理**: 500ms超时

## 扩展功能

### 1. 多图像管理
- 支持存储多张图像
- 图像ID区分不同图像
- 可扩展图像列表管理

### 2. 压缩优化
- 可集成更高效的压缩算法
- 支持有损压缩以减少传输时间

### 3. 显示增强
- 支持图像缩放和旋转
- 多种显示模式
- 图像预览功能

## 故障排除

### 常见问题

1. **传输失败**
   - 检查串口连接
   - 确认波特率设置
   - 检查CRC校验

2. **Flash写入失败**
   - 检查Flash芯片连接
   - 确认Flash空间充足
   - 运行Flash管理器测试

3. **显示异常**
   - 检查EPD连接
   - 确认图像数据完整性
   - 检查显示驱动

### 调试信息
- 通过串口输出详细的调试信息
- 包括传输进度、错误代码、状态变化等

## 代码结构

```
source/
├── image_receiver.h/c    # 图像接收器
├── image_display.h/c     # 图像显示器
├── flash_manager.h/c     # Flash管理器
├── main.c                # 主程序
└── ...

test_sender.py           # 上位机测试程序
README_Image_System.md   # 本文档
```

## 版本信息

- **版本**: 1.0.0
- **作者**: AI Assistant
- **日期**: 2024
- **许可**: BSD 3-Clause

## 技术支持

如有问题，请检查:
1. 硬件连接是否正确
2. 软件配置是否匹配
3. 调试信息输出
4. 本文档的故障排除部分